<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Receiver</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #remoteVideo { width: 100%; height: auto; }
        #status { color: #666; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>Receiving WebRTC Stream</h2>
    <video id="remoteVideo" autoplay playsinline controls muted></video>
    <p id="status">Status: Waiting for stream...</p>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ws = new WebSocket('ws://ws-server:8080');
            const peer = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });
            const video = document.getElementById('remoteVideo');

            peer.ontrack = event => {
                if (video.srcObject !== event.streams[0]) {
                    video.srcObject = event.streams[0];
                    console.log('New stream received.');
                    video.play()
                        .then(() => {
                            console.log('Video playback started automatically while muted.');
                            video.muted = false; // Unmute after successful autoplay
                            document.getElementById('status').textContent = 'Status: Stream active';
                        })
                        .catch(error => {
                            console.error('Failed to start video playback automatically:', error);
                            document.getElementById('status').textContent = 'Status: Auto-play failed; please click to play';
                            video.onclick = () => video.play(); // Allow manual play if autoplay fails
                        });
                }
            };

            peer.oniceconnectionstatechange = () => {
                console.log('ICE connection state change:', peer.iceConnectionState);
                if (['disconnected', 'failed', 'closed'].includes(peer.iceConnectionState)) {
                    console.log('ICE connection state is disconnected, failed, or closed.');
                    document.getElementById('status').textContent = 'Status: Connection failed or disconnected';
                }
            };

            ws.onmessage = event => {
                const message = JSON.parse(event.data);
                console.log('Message received:', message.type);
                switch (message.type) {
                    case 'offer':
                        console.log('Offer received, setting remote description.');
                        peer.setRemoteDescription(new RTCSessionDescription(message.data))
                            .then(() => peer.createAnswer())
                            .then(answer => peer.setLocalDescription(answer))
                            .then(() => {
                                console.log('Local description set, sending answer.');
                                ws.send(JSON.stringify({ type: 'answer', data: peer.localDescription }));
                            })
                            .catch(error => console.error('Error during SDP exchange:', error));
                        break;
                    case 'candidate':
                        console.log('ICE candidate received, adding to peer connection.');
                        peer.addIceCandidate(new RTCIceCandidate(message.data))
                            .catch(error => console.error('Failed to add ICE candidate:', error));
                        break;
                }
            };

            ws.onopen = () => {
                console.log('Connected to WebSocket server.');
                document.getElementById('status').textContent = 'Connected to WebSocket server.';
            };
            ws.onerror = error => {
                console.error('WebSocket Error:', error);
                document.getElementById('status').textContent = 'WebSocket Error';
            };
            ws.onclose = () => {
                console.log('WebSocket connection closed.');
                document.getElementById('status').textContent = 'WebSocket disconnected';
            };
        });
    </script>
</body>
</html>

